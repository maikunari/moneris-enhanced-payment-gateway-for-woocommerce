/*! Moneris Enhanced Gateway - Checkout Handler v1.0.0 | (c) 2025 | moneris-enhanced-gateway-for-woocommerce */
!function(e){"use strict";class t{constructor(){this.tokenReceived=!1,this.isProcessing=!1,this.iframe=null,this.checkoutForm=null,this.retryCount=0,this.maxRetries=3,this.init()}init(){this.iframe=document.getElementById("monerisFrame"),this.iframe?(this.checkoutForm=e("form.checkout, form#order_review"),this.setupEventListeners(),this.setupCheckoutIntegration(),this.log("Moneris checkout handler initialized")):this.log("Iframe not found - standard checkout mode")}setupEventListeners(){const t=this;window.addEventListener("message",e=>{this.handleIframeMessage(e)},!1),e(document.body).on("updated_checkout",()=>{this.sendBillingDataToIframe()}),e(document.body).on("change",'input[name="payment_method"]',()=>{this.handlePaymentMethodChange()}),e(document.body).on("checkout_error",()=>{this.resetToken(),this.hideLoading()}),this.iframe&&(this.iframe.onload=function(){t.log("Iframe loaded successfully"),t.sendBillingDataToIframe()})}handleIframeMessage(e){if(!["https://esqa.moneris.com","https://www3.moneris.com"].includes(e.origin))return void console.warn("Invalid message origin:",e.origin);const t=this.parseResponse(e.data);if(this.log("Iframe message received",t),"001"===t.responseCode||"000"===t.responseCode)this.handleTokenSuccess(t.dataKey||t.token);else if(t.responseCode&&"001"!==t.responseCode){const e=t.errorMessage||this.getErrorMessage(t.responseCode);this.handleTokenError(e)}else t.errorMessage?this.handleTokenError(t.errorMessage):"loaded"===t.type?(this.log("Iframe confirmed loaded"),this.sendBillingDataToIframe()):"resize"===t.type&&this.handleResize(t.height)}parseResponse(e){if("object"==typeof e)return e;const t={};if("string"==typeof e){if(e.startsWith("{"))try{return JSON.parse(e)}catch(e){this.log("Failed to parse JSON response",e)}e.split("&").forEach(e=>{const[i,s]=e.split("=");i&&(t[i]=decodeURIComponent(s||""))})}return t}handleTokenSuccess(t){t?(this.log("Token received successfully"),this.tokenReceived=!0,e("#moneris_token").val(t),e(".moneris-error-container").hide(),this.isProcessing&&this.submitCheckout()):(this.log("Token success but no token provided"),this.handleTokenError("Payment token not received. Please try again."))}handleTokenError(e){this.log("Token error",e),this.showError(e||"Payment authorization failed. Please try again."),this.hideLoading(),this.resetToken(),this.retryCount<this.maxRetries&&(this.retryCount++,this.isProcessing=!1)}sendBillingDataToIframe(){if(!this.iframe||!this.iframe.contentWindow)return void this.log("Cannot send data - iframe not ready");const t={bill_first_name:e("#billing_first_name").val(),bill_last_name:e("#billing_last_name").val(),bill_company_name:e("#billing_company").val(),bill_address_one:e("#billing_address_1").val(),bill_address_two:e("#billing_address_2").val(),bill_city:e("#billing_city").val(),bill_state_or_province:e("#billing_state").val(),bill_postal_code:e("#billing_postcode").val(),bill_country:e("#billing_country").val(),bill_phone:e("#billing_phone").val(),email:e("#billing_email").val()};e("#ship-to-different-address-checkbox").is(":checked")?(t.ship_first_name=e("#shipping_first_name").val(),t.ship_last_name=e("#shipping_last_name").val(),t.ship_company_name=e("#shipping_company").val(),t.ship_address_one=e("#shipping_address_1").val(),t.ship_city=e("#shipping_city").val(),t.ship_state_or_province=e("#shipping_state").val(),t.ship_postal_code=e("#shipping_postcode").val(),t.ship_country=e("#shipping_country").val()):(t.ship_first_name=t.bill_first_name,t.ship_last_name=t.bill_last_name,t.ship_company_name=t.bill_company_name,t.ship_address_one=t.bill_address_one,t.ship_city=t.bill_city,t.ship_state_or_province=t.bill_state_or_province,t.ship_postal_code=t.bill_postal_code,t.ship_country=t.bill_country);const i=this.getOrderTotal();i&&(t.charge_total=i);const s=Object.keys(t).filter(e=>t[e]).map(e=>`${e}=${encodeURIComponent(t[e])}`).join("&"),r=moneris_checkout_params.iframe_origin||"*";this.log("Sending billing data to iframe",r),this.iframe.contentWindow.postMessage(s,r)}getOrderTotal(){let t=e("#order_review .order-total .amount").text();return t||(t=e(".order-total .woocommerce-Price-amount").text()),t||(t=e(".cart-subtotal .woocommerce-Price-amount").text()),t?(t=t.replace(/[^0-9.,]/g,""),t=t.replace(",","."),t=parseFloat(t),t.toFixed(2)):""}setupCheckoutIntegration(){const t=this;e(document.body).on("checkout_place_order_moneris_enhanced",function(){return t.isOurPaymentMethod()?t.tokenReceived?(t.log("Token already available, proceeding with checkout"),!0):t.validateRequiredFields()?(t.showLoading(),t.isProcessing=!0,t.requestToken(),!1):!1:!0})}isOurPaymentMethod(){return e("#payment_method_moneris_enhanced").is(":checked")}handlePaymentMethodChange(){this.isOurPaymentMethod()?(e("#moneris-payment-form").show(),this.sendBillingDataToIframe()):(e("#moneris-payment-form").hide(),this.resetToken())}validateRequiredFields(){const t=["#billing_first_name","#billing_last_name","#billing_address_1","#billing_city","#billing_postcode","#billing_email"];for(let i of t)if(!e(i).val())return this.showError("Please fill in all required billing fields."),e(i).focus(),!1;return!0}requestToken(){if(!this.iframe||!this.iframe.contentWindow)return void this.handleTokenError("Payment iframe not loaded. Please refresh and try again.");const e=moneris_checkout_params.iframe_origin||"*";this.log("Requesting token from iframe"),this.iframe.contentWindow.postMessage("requestToken=true",e),setTimeout(()=>{!this.tokenReceived&&this.isProcessing&&(this.handleTokenError("Payment request timed out. Please try again."),this.isProcessing=!1)},3e4)}submitCheckout(){this.log("Submitting checkout with token"),e(document.body).off("checkout_place_order_moneris_enhanced"),this.checkoutForm.length?this.checkoutForm.submit():e("#place_order").trigger("click")}resetToken(){this.tokenReceived=!1,this.isProcessing=!1,e("#moneris_token").val(""),e("#moneris_token_response").val("")}handleResize(e){this.iframe&&e&&(this.iframe.style.height=e+"px",this.log("Iframe resized to",e))}showLoading(){e(".moneris-loading").show(),e("#place_order").prop("disabled",!0).addClass("processing"),this.checkoutForm.addClass("processing")}hideLoading(){e(".moneris-loading").hide(),e("#place_order").prop("disabled",!1).removeClass("processing"),this.checkoutForm.removeClass("processing")}showError(t){e(".moneris-error").text(t),e(".moneris-error-container").show();const i=e(".moneris-error-container").offset();i&&e("html, body").animate({scrollTop:i.top-100},500),e(document.body).trigger("checkout_error",[t])}getErrorMessage(e){return{"050":"Transaction declined. Please try another card.","051":"Insufficient funds.","052":"Card expired.","053":"Invalid card number.","054":"Invalid CVV.","055":"Card not supported.",200:"Communication error. Please try again.",201:"Invalid merchant configuration.",475:"Transaction cancelled.",476:"Transaction failed. Please try again.",481:"Transaction declined by bank.",482:"Transaction not permitted.",900:"Service temporarily unavailable."}[e]||`Transaction failed (Error ${e}). Please try again.`}log(e,t){moneris_checkout_params&&moneris_checkout_params.debug&&console.log("[Moneris]",e,t||"")}}e(document).ready(function(){e("#monerisFrame").length>0&&(window.monerisCheckout=new t)}),e(document.body).on("updated_checkout",function(){e("#monerisFrame").length>0&&!window.monerisCheckout&&(window.monerisCheckout=new t)})}(jQuery);