(o=>{class e{constructor(){this.tokenReceived=!1,this.isProcessing=!1,this.iframe=null,this.checkoutForm=null,this.retryCount=0,this.maxRetries=3,this.init()}init(){this.iframe=document.getElementById("monerisFrame"),this.iframe?(this.checkoutForm=o("form.checkout, form#order_review"),this.setupEventListeners(),this.setupCheckoutIntegration(),this.log("Moneris checkout handler initialized")):this.log("Iframe not found - standard checkout mode")}setupEventListeners(){let e=this;window.addEventListener("message",e=>{this.handleIframeMessage(e)},!1),o(document.body).on("updated_checkout",()=>{this.sendBillingDataToIframe()}),o(document.body).on("change",'input[name="payment_method"]',()=>{this.handlePaymentMethodChange()}),o(document.body).on("checkout_error",()=>{this.resetToken(),this.hideLoading()}),this.iframe&&(this.iframe.onload=function(){e.log("Iframe loaded successfully"),e.sendBillingDataToIframe()})}handleIframeMessage(e){var i,t;["https://esqa.moneris.com","https://www3.moneris.com"].includes(e.origin)?(i=this.parseResponse(e.data),this.log("Iframe message received",i),"001"===i.responseCode||"000"===i.responseCode?this.handleTokenSuccess(i.dataKey||i.token):i.responseCode&&"001"!==i.responseCode?(t=i.errorMessage||this.getErrorMessage(i.responseCode),this.handleTokenError(t)):i.errorMessage?this.handleTokenError(i.errorMessage):"loaded"===i.type?(this.log("Iframe confirmed loaded"),this.sendBillingDataToIframe()):"resize"===i.type&&this.handleResize(i.height)):console.warn("Invalid message origin:",e.origin)}parseResponse(e){if("object"==typeof e)return e;let t={};if("string"==typeof e){if(e.startsWith("{"))try{return JSON.parse(e)}catch(e){this.log("Failed to parse JSON response",e)}e.split("&").forEach(e=>{var[e,i]=e.split("=");e&&(t[e]=decodeURIComponent(i||""))})}return t}handleTokenSuccess(e){e?(this.log("Token received successfully"),this.tokenReceived=!0,o("#moneris_token").val(e),o(".moneris-error-container").hide(),this.isProcessing&&this.submitCheckout()):(this.log("Token success but no token provided"),this.handleTokenError("Payment token not received. Please try again."))}handleTokenError(e){this.log("Token error",e),this.showError(e||"Payment authorization failed. Please try again."),this.hideLoading(),this.resetToken(),this.retryCount<this.maxRetries&&(this.retryCount++,this.isProcessing=!1)}sendBillingDataToIframe(){if(this.iframe&&this.iframe.contentWindow){let i={bill_first_name:o("#billing_first_name").val(),bill_last_name:o("#billing_last_name").val(),bill_company_name:o("#billing_company").val(),bill_address_one:o("#billing_address_1").val(),bill_address_two:o("#billing_address_2").val(),bill_city:o("#billing_city").val(),bill_state_or_province:o("#billing_state").val(),bill_postal_code:o("#billing_postcode").val(),bill_country:o("#billing_country").val(),bill_phone:o("#billing_phone").val(),email:o("#billing_email").val()};o("#ship-to-different-address-checkbox").is(":checked")?(i.ship_first_name=o("#shipping_first_name").val(),i.ship_last_name=o("#shipping_last_name").val(),i.ship_company_name=o("#shipping_company").val(),i.ship_address_one=o("#shipping_address_1").val(),i.ship_city=o("#shipping_city").val(),i.ship_state_or_province=o("#shipping_state").val(),i.ship_postal_code=o("#shipping_postcode").val(),i.ship_country=o("#shipping_country").val()):(i.ship_first_name=i.bill_first_name,i.ship_last_name=i.bill_last_name,i.ship_company_name=i.bill_company_name,i.ship_address_one=i.bill_address_one,i.ship_city=i.bill_city,i.ship_state_or_province=i.bill_state_or_province,i.ship_postal_code=i.bill_postal_code,i.ship_country=i.bill_country);var e=this.getOrderTotal(),e=(e&&(i.charge_total=e),Object.keys(i).filter(e=>i[e]).map(e=>e+"="+encodeURIComponent(i[e])).join("&")),t=moneris_checkout_params.iframe_origin||"*";this.log("Sending billing data to iframe",t),this.iframe.contentWindow.postMessage(e,t)}else this.log("Cannot send data - iframe not ready")}getOrderTotal(){let e=o("#order_review .order-total .amount").text();return(e=(e=e||o(".order-total .woocommerce-Price-amount").text())||o(".cart-subtotal .woocommerce-Price-amount").text())?(e=(e=e.replace(/[^0-9.,]/g,"")).replace(",","."),(e=parseFloat(e)).toFixed(2)):""}setupCheckoutIntegration(){let e=this;o(document.body).on("checkout_place_order_moneris_enhanced",function(){return!e.isOurPaymentMethod()||(e.tokenReceived?(e.log("Token already available, proceeding with checkout"),!0):(e.validateRequiredFields()&&(e.showLoading(),e.isProcessing=!0,e.requestToken()),!1))})}isOurPaymentMethod(){return o("#payment_method_moneris_enhanced").is(":checked")}handlePaymentMethodChange(){this.isOurPaymentMethod()?(o("#moneris-payment-form").show(),this.sendBillingDataToIframe()):(o("#moneris-payment-form").hide(),this.resetToken())}validateRequiredFields(){var e;for(e of["#billing_first_name","#billing_last_name","#billing_address_1","#billing_city","#billing_postcode","#billing_email"])if(!o(e).val())return this.showError("Please fill in all required billing fields."),o(e).focus(),!1;return!0}requestToken(){var e;this.iframe&&this.iframe.contentWindow?(e=moneris_checkout_params.iframe_origin||"*",this.log("Requesting token from iframe"),this.iframe.contentWindow.postMessage("requestToken=true",e),setTimeout(()=>{!this.tokenReceived&&this.isProcessing&&(this.handleTokenError("Payment request timed out. Please try again."),this.isProcessing=!1)},3e4)):this.handleTokenError("Payment iframe not loaded. Please refresh and try again.")}submitCheckout(){this.log("Submitting checkout with token"),o(document.body).off("checkout_place_order_moneris_enhanced"),this.checkoutForm.length?this.checkoutForm.submit():o("#place_order").trigger("click")}resetToken(){this.tokenReceived=!1,this.isProcessing=!1,o("#moneris_token").val(""),o("#moneris_token_response").val("")}handleResize(e){this.iframe&&e&&(this.iframe.style.height=e+"px",this.log("Iframe resized to",e))}showLoading(){o(".moneris-loading").show(),o("#place_order").prop("disabled",!0).addClass("processing"),this.checkoutForm.addClass("processing")}hideLoading(){o(".moneris-loading").hide(),o("#place_order").prop("disabled",!1).removeClass("processing"),this.checkoutForm.removeClass("processing")}showError(e){o(".moneris-error").text(e),o(".moneris-error-container").show();var i=o(".moneris-error-container").offset();i&&o("html, body").animate({scrollTop:i.top-100},500),o(document.body).trigger("checkout_error",[e])}getErrorMessage(e){return{"050":"Transaction declined. Please try another card.","051":"Insufficient funds.","052":"Card expired.","053":"Invalid card number.","054":"Invalid CVV.","055":"Card not supported.",200:"Communication error. Please try again.",201:"Invalid merchant configuration.",475:"Transaction cancelled.",476:"Transaction failed. Please try again.",481:"Transaction declined by bank.",482:"Transaction not permitted.",900:"Service temporarily unavailable."}[e]||`Transaction failed (Error ${e}). Please try again.`}log(e,i){moneris_checkout_params&&moneris_checkout_params.debug&&console.log("[Moneris]",e,i||"")}}o(document).ready(function(){0<o("#monerisFrame").length&&(window.monerisCheckout=new e)}),o(document.body).on("updated_checkout",function(){0<o("#monerisFrame").length&&!window.monerisCheckout&&(window.monerisCheckout=new e)})})(jQuery);